<!DOCTYPE html>
<html>
<head>
    <title>JPY Web Terminal</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-bg: #252526;
            --text-color: #cccccc;
            --hover-bg: #37373d;
            --border-color: #3e3e42;
            --accent-color: #007acc;
        }
        body { margin: 0; padding: 0; background: var(--bg-color); height: 100vh; display: flex; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; color: var(--text-color); }
        
        /* Sidebar */
        #sidebar {
            width: 250px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: width 0.3s;
        }
        #sidebar-header {
            padding: 15px;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #command-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        .command-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            border-left: 3px solid transparent;
        }
        .command-item:hover {
            background: var(--hover-bg);
        }
        .command-item:active {
            background: #2a2d2e;
        }
        .command-name {
            font-weight: 500;
            margin-bottom: 2px;
        }
        .command-cmd {
            font-size: 11px;
            opacity: 0.6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: monospace;
        }
        
        /* Terminal Area */
        #terminal-container {
            flex: 1;
            position: relative;
            background: var(--bg-color);
            padding: 10px;
            overflow: hidden;
        }
        #terminal { width: 100%; height: 100%; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--sidebar-bg); }
        ::-webkit-scrollbar-thumb { background: #4e4e52; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #5e5e62; }
    </style>
</head>
<body>
    <div id="sidebar">
        <div id="sidebar-header">
            <span>常用命令</span>
            <button id="refresh-btn" style="background:none; border:none; color:inherit; cursor:pointer;" title="刷新配置">↻</button>
        </div>
        <div id="command-list">
            <!-- Commands will be injected here -->
        </div>
    </div>
    
    <div id="terminal-container">
        <div id="terminal"></div>
    </div>

    <script>
        // Terminal Setup
        const term = new Terminal({
            cursorBlink: true,
            theme: {
                background: '#1e1e1e',
                foreground: '#cccccc',
                selectionBackground: '#5da5d533',
            },
            fontFamily: 'Menlo, Monaco, "Courier New", monospace',
            fontSize: 14,
            allowProposedApi: true
        });
        const fitAddon = new FitAddon.FitAddon();
        const webLinksAddon = new WebLinksAddon.WebLinksAddon();
        
        term.loadAddon(fitAddon);
        term.loadAddon(webLinksAddon);
        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        // WebSocket Setup
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const socket = new WebSocket(protocol + '//' + window.location.host + '/ws');

        term.onData(data => {
            socket.send(JSON.stringify({type: 'input', data: data}));
        });

        term.onResize(size => {
            socket.send(JSON.stringify({type: 'resize', cols: size.cols, rows: size.rows}));
        });

        socket.onopen = () => {
            term.write('\r\n\x1b[32mConnected to JPY Web Terminal\x1b[0m\r\n');
            socket.send(JSON.stringify({type: 'resize', cols: term.cols, rows: term.rows}));
        };

        socket.onmessage = (event) => {
            if (event.data instanceof Blob) {
                const reader = new FileReader();
                reader.onload = () => term.write(new Uint8Array(reader.result));
                reader.readAsArrayBuffer(event.data);
            } else {
                // Check if it's a control message (JSON)
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'config') {
                        renderCommands(msg.commands);
                        return;
                    }
                } catch (e) {
                    // Not JSON, treat as terminal output
                }
                term.write(event.data);
            }
        };

        socket.onclose = () => {
            term.write('\r\n\x1b[31mConnection closed\x1b[0m\r\n');
        };

        window.addEventListener('resize', () => fitAddon.fit());

        // Quick Commands Logic
        function renderCommands(commands) {
            const list = document.getElementById('command-list');
            list.innerHTML = '';
            
            if (!commands || commands.length === 0) {
                // Default commands if none provided
                commands = [
                    {name: "查看中间件设备", cmd: "jpy middleware device list"},
                    {name: "查看中间件状态", cmd: "jpy middleware status"},
                    {name: "生成 IP 配置", cmd: "jpy tools middleware create"},
                    {name: "清屏", cmd: "clear"},
                    {name: "退出", cmd: "exit"}
                ];
            }

            commands.forEach(c => {
                const div = document.createElement('div');
                div.className = 'command-item';
                div.innerHTML = `
                    <div class="command-name">${c.name}</div>
                    <div class="command-cmd" title="${c.cmd}">${c.cmd}</div>
                `;
                div.onclick = () => {
                    // Send command + enter
                    socket.send(JSON.stringify({type: 'input', data: c.cmd + '\r'}));
                    term.focus();
                };
                list.appendChild(div);
            });
        }
        
        // Initial request for config
        // Wait a bit for socket to be ready, although onopen handles resize, 
        // we can fetch config via HTTP or wait for server to push it.
        // Let's fetch via HTTP to be simple.
        fetch('/config/commands')
            .then(res => res.json())
            .then(data => renderCommands(data))
            .catch(() => renderCommands([])); // Fallback to defaults

        document.getElementById('refresh-btn').onclick = () => {
            fetch('/config/commands')
                .then(res => res.json())
                .then(data => renderCommands(data));
        };
    </script>
</body>
</html>
